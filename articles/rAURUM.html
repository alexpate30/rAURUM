<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rAURUM">
<title>rAURUM: An R package to simplify the processing of CPRD Aurum data and convert into an analysis-ready dataset • rAURUM</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="rAURUM: An R package to simplify the processing of CPRD Aurum data and convert into an analysis-ready dataset">
<meta property="og:description" content="rAURUM">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rAURUM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/rAURUM.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>rAURUM: An R package to simplify the processing of CPRD Aurum data and convert into an analysis-ready dataset</h1>
            
      
      
      <div class="d-none name"><code>rAURUM.Rmd</code></div>
    </div>

    
    
<p><em>This article does not contain any real patient data. All patient
data has been simulated but formatted to match the structure of CPRD
Aurum data.</em></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Clinical Practice Research Datalink (CPRD) is a primary care database
containing information on demography, medical history, test results and
drug use. CPRD maintain two databases, CPRD GOLD which contains data
from general practices using the Vision computer system, and CPRD Aurum,
which contains data from general practices using the EMIS computer
system. As of June 2024, these databases contain data on 21 million (3
million currently registered) <span class="citation">(CPRD 2024b)</span>
and 47 million (16 million currently registered) <span class="citation">(CPRD 2024a)</span> individuals respectively. CPRD is a
widely used resource. Since 2019, using the PubMed library, there has
been 540 studies published which contain “CPRD” in the title or
abstract. Extraction of CPRD data into an analysable format is a
computationally demanding process and requires a significant amount of
work. Despite this, there is little software available to aid
researchers in the extraction and processing of CPRD data.</p>
<p><strong>rEHR</strong> <span class="citation">(Springate et al.
2017)</span> is an R package for manipulating and analysing eletronic
health record data, which works by creating an SQLite database on the
hard disk, which is then subsequently queried to extract relevant
information. <strong>rEHR</strong> was designed to be database agnostic,
and contains functionality for longitudinal data extraction, cutting
data by time-varying covariates, matching controls to cases, converting
the units of test data, and creation of clinical code lists.
<strong>rEHR</strong> is however is no longer maintained and has been
removed from CRAN. The <strong>aurumpipeline</strong> package <span class="citation">(The Health Foundation Analytics Lab 2021)</span>
contains functions to clean and process CPRD Aurum data, which works by
storing the data as parquet files on the hard disk, which are then
subsequently queried to extract relevant data. However,
<strong>aurumpipeline</strong> is not available on CRAN and is not
provided with any reproducible examples. The R package
<strong>drugprepr</strong> <span class="citation">(Yimer et al.
2021)</span> implements the algorithm of <span class="citation">Pye et
al. (2018)</span> for preparing drug exposure data extracted from CPRD,
however it does not deal with the initial data extraction and storing of
data.</p>
<p>Given the large number of studies using CPRD data, and the lack of
available software for data processing, this indicates that a large
amount of research time is being spent duplicating the work of others in
order to extract CPRD data. This study introduces
<strong>rAURUM</strong>, an R package designed to assist researchers in
working with CPRD Aurum data and creating datasets which are
analysis-ready. We start by outlining the issues encountered when
working with CPRD Aurum data and the approach taken by
<strong>rAURUM</strong> for processing this data, which draws heavily on
the work of <span class="citation">Springate et al. (2017)</span>.
<strong>rAURUM</strong> has two main groups of functions. The first are
to extract and store data in a consistent manner. The second set is to
query this data to extract patient level data in order to create
analysis-ready datasets. We then run through a worked example to
showcase the functionality of <strong>rAURUM</strong>. We focus on CPRD
Aurum, as opposed to CPRD GOLD, given there has been a considerable drop
in the number of practices utilising Vision software in the last 10
years, limiting the research utility of the CPRD GOLD database. However,
this package can also be used to manage linked secondary care (HES) and
ONS death data, and is flexible to the point that it could be used to
extract and store data from any electronic health record, which will be
touched on in the discussion.</p>
</div>
<div class="section level2">
<h2 id="data-structure-and-extraction-process">Data Structure and Extraction Process<a class="anchor" aria-label="anchor" href="#data-structure-and-extraction-process"></a>
</h2>
<div class="section level3">
<h3 id="structure-of-cprd-aurum-data">Structure of CPRD Aurum data<a class="anchor" aria-label="anchor" href="#structure-of-cprd-aurum-data"></a>
</h3>
<p>We first define some terminology which will be used throughout this
article. <em>Raw data</em>: The raw data provided to the user by CPRD.
<em>Cohort:</em> A cohort of individuals that meet the
inclusion/exclusion criteria for a given research question. In this
setting, the cohort is ultimately a vector of patient id’s.
<em>Analysis-ready dataset</em>: A data frame with one row for each
individual in the cohort, and a column for each variable of interest,
for example, age at cohort entry, or most recent BMI score prior to
cohort entry.</p>
<p>The raw data is split into eight different file types: Consultation,
DrugIssue, Observation, Patient, Practice, Problem, Referral, Staff. The
data specification is available here: <span class="citation">(CPRD
2022)</span>. For most research questions, the relevant files are
Patient, Observation and DrugIssue. The Patient file contains
information about registration into the database, date of death or lost
to follow up, year of birth and gender. This file will be required to
define a cohort. The observation file contains all medical diagnoses and
tests, while drugissue contains information on prescriptions. Medical
observations are identified by their <em>medcodeid</em>, whereas
prescriptions are identified through their <em>prodcodeid</em>.</p>
<p>In order to facilitate data transfer, this data is commonly split
into into numerous smaller files. The different patient files are
denoted by the string <em>set1</em>, <em>set2</em>, <em>set3</em> in the
file name. Individuals in the same patient file will have the
corresponding string (<em>setX</em>) in the files containing their
medical or prescription data. However, there will be more than one
Observation and DrugIssue file corresponding to each patient file. For
example, the observation files for patients in <em>set1</em>, will have
<em>set1</em> in their file name, and then an extra suffix 1, 2, 3, etc.
The same is true for the DrugIssue files. The naming structure for these
is as follows:</p>
<ul>
<li>aurum_allpatid_set<em>X</em>_extract_patient_001.txt</li>
<li>aurum_allpatid_set<em>X</em>_extract_observation_00<em>Y</em>.txt</li>
<li>aurum_allpatid_set<em>X</em>_extract_drugissue_00<em>Y</em>.txt</li>
</ul>
<p>where <em>X</em> and <em>Y</em> take integer values. Note that prefix
to the file names may vary (i.e. the <em>aurum_allpatid</em> part)
however we expect the naming convention with regards to <em>setX</em>,
file type, and <em>00Y</em> to remain consistent. If this changes in the
future, we will endeavour to update the <strong>rAURUM</strong> as soon
as possible.</p>
</div>
<div class="section level3">
<h3 id="overarching-process">Overarching process<a class="anchor" aria-label="anchor" href="#overarching-process"></a>
</h3>
<p>The main problem when working with CPRD Aurum data is the size of the
raw data. Data on over 47 million individuals results in thousands of
raw .txt files, and Terabytes of data, which can be cumbersome work
with. This is a particular issue for R users, as its unfeasible to read
all this data into the R workspace simultaneously, as R operates using
RAM. As suggested by <span class="citation">Springate et al.
(2017)</span>, <strong>rAURUM</strong> bypassess this problem by
creating an SQLite database which can be saved onto the hard disk on
your computer system. This SQLite database can then be queried for data
of interest in order to build an analysis-ready dataset.</p>
<p>Our recommended process for developing an analysis-ready dataset is
as follows (see Figure XXXX for a visual representation of this):</p>
<ul>
<li>Step 1: Define cohort of interest by applying inclusion/exclusion
criteria.</li>
<li>Step 2: Read raw data for individuals in the cohort of interest into
R, and write this data into an SQLite database.</li>
<li>Step 3: Query this SQLite database for specific codes and tests to
create variables for each individual in the cohort.</li>
<li>Step 4: Combine extracted variables into an analysis-ready
dataset.</li>
</ul>
<p>We recommend this process because once set up, querying the SQLite
database is computationally much quicker than reading each of the raw
files into the R workspace and querying these separately. It also
reduces the probability of errors induced from creating numerous for
loops when looping through the raw data files. We now move onto a worked
example, where we showcase how to implement the above process using
<strong>rAURUM</strong>.</p>
</div>
</div>
<div class="section level2">
<h2 id="worked-example-for-data-extraction">Worked example for data extraction<a class="anchor" aria-label="anchor" href="#worked-example-for-data-extraction"></a>
</h2>
<div class="section level3">
<h3 id="step-1-defining-a-cohort">Step 1: Defining a cohort<a class="anchor" aria-label="anchor" href="#step-1-defining-a-cohort"></a>
</h3>
<p>We have provided simulated patient, observation and drugissue files
with these naming conventions, which will be utilisied in the worked
example. They are contained in the <em>inst/aurum_data</em> directory of
<strong>rAURUM</strong>. After installing <strong>rAURUM</strong>, this
directory can be accessed using the command
<code>system.file("aurum_data", package = "rAURUM")</code>. This
contains data on 12 fake patients, split across two patient files
(<em>set1</em> and <em>set2</em>) and three observation and drugissue
files (all <em>set1</em>):</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#devtools::install_github("alexpate30/rAURUM")</span></span>
<span><span class="co">#install.packages("rAURUM") NOT YET ON CRAN</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://alexpate30.github.io/rAURUM/">rAURUM</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: data.table</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, package <span class="op">=</span> <span class="st">"rAURUM"</span><span class="op">)</span>, pattern <span class="op">=</span> <span class="st">".txt"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "aurum_allpatid_set1_extract_drugissue_001.txt"  </span></span>
<span><span class="co">#&gt; [2] "aurum_allpatid_set1_extract_drugissue_002.txt"  </span></span>
<span><span class="co">#&gt; [3] "aurum_allpatid_set1_extract_drugissue_003.txt"  </span></span>
<span><span class="co">#&gt; [4] "aurum_allpatid_set1_extract_observation_001.txt"</span></span>
<span><span class="co">#&gt; [5] "aurum_allpatid_set1_extract_observation_002.txt"</span></span>
<span><span class="co">#&gt; [6] "aurum_allpatid_set1_extract_observation_003.txt"</span></span>
<span><span class="co">#&gt; [7] "aurum_allpatid_set1_extract_patient_001.txt"    </span></span>
<span><span class="co">#&gt; [8] "aurum_allpatid_set2_extract_patient_001.txt"</span></span></code></pre></div>
<p>The first step in most analyses is creating and defining a cohort of
individuals, which will involve working with the patient files. Data
from the patient files can be combined using the
<code>extract_cohort</code> function. This will look in the directory
specified through the <code>filepath</code> argument, for any file
containing “patient” in the file name. All files will be read in and
concatenated into a single dataset. In some circumstances, researchers
may be provided with a list of patids which meet their
inclusion/exclusion criteria. In this case, these can be specified
through the <code>patids</code> argument (which requires a character
vector). Suppose the individuals meeting the exclusion criteria are
those with patid = 1, 3, 4 and 6. We would then specify:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_cohort.html">extract_cohort</a></span><span class="op">(</span>filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, package <span class="op">=</span> <span class="st">"rAURUM"</span><span class="op">)</span>, patids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">6</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">pat</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    4 obs. of  12 variables:</span></span>
<span><span class="co">#&gt;  $ patid         : chr  "1" "3" "4" "6"</span></span>
<span><span class="co">#&gt;  $ pracid        : int  49 98 53 54</span></span>
<span><span class="co">#&gt;  $ usualgpstaffid: chr  "6" "43" "72" "11"</span></span>
<span><span class="co">#&gt;  $ gender        : int  2 1 2 1</span></span>
<span><span class="co">#&gt;  $ yob           : int  1984 1930 1915 1914</span></span>
<span><span class="co">#&gt;  $ mob           : int  NA NA NA NA</span></span>
<span><span class="co">#&gt;  $ emis_ddate    : Date, format: "1976-11-21" "1972-06-01" ...</span></span>
<span><span class="co">#&gt;  $ regstartdate  : Date, format: "1940-07-24" "1913-07-02" ...</span></span>
<span><span class="co">#&gt;  $ patienttypeid : int  58 81 10 85</span></span>
<span><span class="co">#&gt;  $ regenddate    : Date, format: "1996-08-25" "1997-04-24" ...</span></span>
<span><span class="co">#&gt;  $ acceptable    : int  1 1 0 1</span></span>
<span><span class="co">#&gt;  $ cprd_ddate    : Date, format: "1935-03-17" "1912-04-27" ...</span></span></code></pre></div>
<p>In other circumstances, a user may need to apply the inclusion and
exclusion criteria themselves. In this case, one would initially create
a patient file for all individuals.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_cohort.html">extract_cohort</a></span><span class="op">(</span>filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, package <span class="op">=</span> <span class="st">"rAURUM"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">pat</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    12 obs. of  12 variables:</span></span>
<span><span class="co">#&gt;  $ patid         : chr  "1" "2" "3" "4" ...</span></span>
<span><span class="co">#&gt;  $ pracid        : int  49 79 98 53 62 54 49 79 98 53 ...</span></span>
<span><span class="co">#&gt;  $ usualgpstaffid: chr  "6" "11" "43" "72" ...</span></span>
<span><span class="co">#&gt;  $ gender        : int  2 1 1 2 2 1 2 1 1 2 ...</span></span>
<span><span class="co">#&gt;  $ yob           : int  1984 1932 1930 1915 1916 1914 1984 1932 1930 1915 ...</span></span>
<span><span class="co">#&gt;  $ mob           : int  NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">#&gt;  $ emis_ddate    : Date, format: "1976-11-21" "1979-02-14" ...</span></span>
<span><span class="co">#&gt;  $ regstartdate  : Date, format: "1940-07-24" "1929-02-23" ...</span></span>
<span><span class="co">#&gt;  $ patienttypeid : int  58 21 81 10 45 85 58 21 81 10 ...</span></span>
<span><span class="co">#&gt;  $ regenddate    : Date, format: "1996-08-25" "1945-03-19" ...</span></span>
<span><span class="co">#&gt;  $ acceptable    : int  1 0 1 0 0 1 1 0 1 0 ...</span></span>
<span><span class="co">#&gt;  $ cprd_ddate    : Date, format: "1935-03-17" "1932-02-05" ...</span></span></code></pre></div>
<p>The cohort of individuals would then be defined by applying study
specific inclusion/exclusion criteria. For example, all individuals with
&gt; 1 day valid follow up aged 65+, after 1st January 2000. Such
criteria can be applied solely using the information available in
patient files. In this example, we define the individuals that met the
inclusion criteria to be those with patid = 1, 3, 4 and 6.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pat</span>, <span class="va">patid</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">6</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Once the cohort has been defined, the next step is to extract
medical/prescription data for these individuals. However, it is also
common for inclusion/exclusion criteria to be dependent on medical
diagnoses and prescription history. For example, an additional inclusion
criteria that individuals must have a diagnosis of type 2 diabetes. To
apply this criteria and reduce the cohort further, you must first
extract medical history data for the cohort. In this case, the steps
outlined in section 2.2 may be altered to:</p>
<ul>
<li>Step 1: Define cohort of interest by applying inclusion/exclusion
criteria that are not dependent on medical history.</li>
<li>Step 2: Read medical/prescription data for cohort of interest into R
and write into an SQLite database.</li>
<li>Step 2.2: Query this SQLite database for specific codes and tests to
apply remaining inclusion/exclusion criteria that are dependent on
medical history.</li>
<li>Step 2.3: [Optional] Reduce SQLite database to only contain data on
individuals in final cohort. This may be worthwhile if the
inclusion/exclusion criteria in step 3 excluded a large number of
individuals. This will mean future queries into the SQLite database will
run much quicker.</li>
<li>Step 3: Query this SQLite database for specific codes and tests to
create variables for each individual in the cohort.</li>
<li>Step 4: Combine extracted variables into an analysis-ready
dataset.</li>
</ul>
</div>
<div class="section level3">
<h3 id="step-2-reading-in-data-and-creating-an-sqlite-database">Step 2: Reading in data and creating an SQLite database<a class="anchor" aria-label="anchor" href="#step-2-reading-in-data-and-creating-an-sqlite-database"></a>
</h3>
<p>Data for individuals in the cohort of interest is extracted from the
.txt files and put into a SQLite database. This SQLite database is
stored on the hard disk and can be queried when defining an
analysis-ready dataset.</p>
<div class="section level4">
<h4 id="add-individual-files-to-sqlite-database-using-add_to_database">Add individual files to SQLite database using
<code>add_to_database</code><a class="anchor" aria-label="anchor" href="#add-individual-files-to-sqlite-database-using-add_to_database"></a>
</h4>
<p>The function <code>add_to_database</code> can be used to add
individual files to the SQLite database. Start by defining and
connecting to your SQLite database. In this article we create a
temporary database, but in practice this would be a permanent location
the hard disk. Specifically, <code>tempfile("temp.sqlite")</code> would
be replaced by the desired file path and SQLite database name.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aurum_extract</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/connect_database.html">connect_database</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"temp.sqlite"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next we add medical diagnoses data from the observation files to this
database using the <code>add_to_database</code> function. The simulated
raw data provided with <strong>rAURUM</strong> can be accessed using the
<code>system.file</code> function. The vector of patient id’s that
defines the cohort is defined through the <code>subset.patids</code>
argument. Only data with patid’s matching this argument will be added to
the SQLite database. The <code>filetype</code> argument will select an
appropriate function for reading in the .txt files, and also defines the
name of the table in the SQLite database that the files are added to.
Note that for the first file, <code>overwrite = TRUE</code> is specified
to create a new table. For the second and third file,
<code>append = TRUE</code> is specified to append to an existing
table.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/add_to_database.html">add_to_database</a></span><span class="op">(</span>filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, <span class="st">"aurum_allpatid_set1_extract_observation_001.txt"</span>, package <span class="op">=</span> <span class="st">"rAURUM"</span><span class="op">)</span>, </span>
<span>                filetype <span class="op">=</span> <span class="st">"observation"</span>, subset.patids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">6</span><span class="op">)</span>, db <span class="op">=</span> <span class="va">aurum_extract</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/add_to_database.html">add_to_database</a></span><span class="op">(</span>filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, <span class="st">"aurum_allpatid_set1_extract_observation_001.txt"</span>, package <span class="op">=</span> <span class="st">"rAURUM"</span><span class="op">)</span>, </span>
<span>                filetype <span class="op">=</span> <span class="st">"observation"</span>, subset.patids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">6</span><span class="op">)</span>, db <span class="op">=</span> <span class="va">aurum_extract</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/add_to_database.html">add_to_database</a></span><span class="op">(</span>filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, <span class="st">"aurum_allpatid_set1_extract_observation_001.txt"</span>, package <span class="op">=</span> <span class="st">"rAURUM"</span><span class="op">)</span>, </span>
<span>                filetype <span class="op">=</span> <span class="st">"observation"</span>, subset.patids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">6</span><span class="op">)</span>, db <span class="op">=</span> <span class="va">aurum_extract</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>We can then query this database, by selecting all rows from the
<em>observation</em> table, and only printing the first 3. More details
on how to query an SQLite database from within R is available in the
documentation for R package RSQLite <span class="citation">(Müller et
al. 2024)</span>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">aurum_extract</span>, <span class="st">'SELECT * FROM observation'</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;   patid consid pracid obsid obsdate enterdate staffid parentobsid</span></span>
<span><span class="co">#&gt; 1     1     33      1   100  -15931      -994      79          95</span></span>
<span><span class="co">#&gt; 2     1     66      1    46  -13782    -15232      34          17</span></span>
<span><span class="co">#&gt; 3     1     41      1    53  -20002      8845      35          79</span></span>
<span><span class="co">#&gt;           medcodeid value numunitid obstypeid numrangelow numrangehigh</span></span>
<span><span class="co">#&gt; 1   498521000006119    48        16        20          28           86</span></span>
<span><span class="co">#&gt; 2         401539014    22         1         2          27            8</span></span>
<span><span class="co">#&gt; 3 13483031000006114    17        78        13          87           41</span></span>
<span><span class="co">#&gt;   probobsid</span></span>
<span><span class="co">#&gt; 1        54</span></span>
<span><span class="co">#&gt; 2        35</span></span>
<span><span class="co">#&gt; 3        74</span></span></code></pre></div>
<p>Note that when reading the raw data into R, the dates are converted
into date formats, with a underlying numeric value where day 0 is
01/01/1970. When saved to the SQLite database, it is the underlying
numeric values which is saved, hence the dates now appearing as numeric
values. Next, the prescription data from the drugissue files is added to
a table called <code>drugissue</code>. A single SQLite database may
contain more than one table, so this data is added to a different table
within the same SQLite database.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/add_to_database.html">add_to_database</a></span><span class="op">(</span>filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, <span class="st">"aurum_allpatid_set1_extract_drugissue_001.txt"</span>, package <span class="op">=</span> <span class="st">"rAURUM"</span><span class="op">)</span>, </span>
<span>                filetype <span class="op">=</span> <span class="st">"drugissue"</span>, subset.patids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">6</span><span class="op">)</span>, db <span class="op">=</span> <span class="va">aurum_extract</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/add_to_database.html">add_to_database</a></span><span class="op">(</span>filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, <span class="st">"aurum_allpatid_set1_extract_drugissue_001.txt"</span>, package <span class="op">=</span> <span class="st">"rAURUM"</span><span class="op">)</span>, </span>
<span>                filetype <span class="op">=</span> <span class="st">"drugissue"</span>, subset.patids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">6</span><span class="op">)</span>, db <span class="op">=</span> <span class="va">aurum_extract</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/add_to_database.html">add_to_database</a></span><span class="op">(</span>filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, <span class="st">"aurum_allpatid_set1_extract_drugissue_001.txt"</span>, package <span class="op">=</span> <span class="st">"rAURUM"</span><span class="op">)</span>, </span>
<span>                filetype <span class="op">=</span> <span class="st">"drugissue"</span>, subset.patids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">6</span><span class="op">)</span>, db <span class="op">=</span> <span class="va">aurum_extract</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Again this table can be queried, by selecting all rows from the
<em>drugissue</em> table, and only printing the first 3.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">aurum_extract</span>, <span class="st">'SELECT * FROM drugissue'</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;   patid issueid pracid probobsid drugrecid issuedate enterdate staffid</span></span>
<span><span class="co">#&gt; 1     1      93      1        88        83    -16118     -1013      98</span></span>
<span><span class="co">#&gt; 2     1      93      1        55        59    -13322    -12900      88</span></span>
<span><span class="co">#&gt; 3     1      16      1        22        82     -8677     -3543      50</span></span>
<span><span class="co">#&gt;         prodcodeid dosageid quantity quantunitid duration estnhscost quanunitid</span></span>
<span><span class="co">#&gt; 1 3092241000033113       58       18          33       27         12          6</span></span>
<span><span class="co">#&gt; 2   92041000033111       62       93          83       59         11         25</span></span>
<span><span class="co">#&gt; 3  971241000033111       87       43          83       88         65         92</span></span></code></pre></div>
<p>Listing the tables in the SQLite database shows there are now two,
named <em>observation</em> and <em>drugissue</em>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">dbListTables</span><span class="op">(</span><span class="va">aurum_extract</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "drugissue"   "observation"</span></span></code></pre></div>
<p>The <code>add_to_database</code> function allows specification of
<code>filetype = c("observation", "drugissue", "referral", "problem", "consultation", "hes_primary","death")</code>,
each corresponding to a specific function for reading in the
corresponding .txt files with correct formatting. The
<code>"hes_primary"</code> options correspond to the primary diagnoses
file in linked HES APC data. The <code>"death"</code> file corresponds
to the death file in the linked ONS data. If wanting to add other files
to the SQLite database, a user defined function for reading in the raw
.txt file can be specified through <code>extract.txt.func</code>, and a
table name can be specified through <code>tablename</code>. This allows
the user to add any .txt file to their SQLite database.</p>
<p>Finally, when manually adding files in this manner, it is good
practice to close the connection to the SQLite database once
finished.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">aurum_extract</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="add-all-relevant-files-to-sqlite-database-using-cprd_extract">Add all relevant files to SQLite database using
<code>cprd_extract</code><a class="anchor" aria-label="anchor" href="#add-all-relevant-files-to-sqlite-database-using-cprd_extract"></a>
</h4>
<p>In practice, there will be a high number of files to add to the
SQLite database and adding each one using <code>add_to_database</code>
would be cumbersome. We now we repeat the extraction but using the
<code>cprd_extract</code> function, which is a wrapper for
<code>add_to_database</code>, and will add all the files in a specified
directory that contain a string matching the specified file type. Start
by creating a connection to a new database:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aurum_extract</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/connect_database.html">connect_database</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"temp.sqlite"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then use <code>cprd_extract</code> to add all the observation
files into the SQLite database. The directory containing the files
should be specified using <code>filepath</code>. It will only read in
and add files with the text string specified in <code>filetype</code>,
which takes values in
<code>c("observation", "drugissue", "referral", "problem", "consultation")</code>.
We then query the first three rows of this database, and note they are
the same as previously.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Extract data</span></span>
<span><span class="fu"><a href="../reference/cprd_extract.html">cprd_extract</a></span><span class="op">(</span><span class="va">aurum_extract</span>, </span>
<span>             filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, package <span class="op">=</span> <span class="st">"rAURUM"</span><span class="op">)</span>, </span>
<span>             filetype <span class="op">=</span> <span class="st">"observation"</span>, subset.patids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">6</span><span class="op">)</span>, use.set <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "nrows -1"</span></span>
<span><span class="co">#&gt; [1] "select "</span></span>
<span><span class="co">#&gt; [1] "use.set FALSE"</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_observation_001.txt 2024-06-12 10:57:17.52534"</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_observation_002.txt 2024-06-12 10:57:17.537944"</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_observation_003.txt 2024-06-12 10:57:17.548684"</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">### Query first three rows</span></span>
<span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">aurum_extract</span>, <span class="st">'SELECT * FROM observation'</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;   patid consid pracid obsid obsdate enterdate staffid parentobsid</span></span>
<span><span class="co">#&gt; 1     1     33      1   100  -15931      -994      79          95</span></span>
<span><span class="co">#&gt; 2     1     66      1    46  -13782    -15232      34          17</span></span>
<span><span class="co">#&gt; 3     1     41      1    53  -20002      8845      35          79</span></span>
<span><span class="co">#&gt;           medcodeid value numunitid obstypeid numrangelow numrangehigh</span></span>
<span><span class="co">#&gt; 1   498521000006119    48        16        20          28           86</span></span>
<span><span class="co">#&gt; 2         401539014    22         1         2          27            8</span></span>
<span><span class="co">#&gt; 3 13483031000006114    17        78        13          87           41</span></span>
<span><span class="co">#&gt;   probobsid</span></span>
<span><span class="co">#&gt; 1        54</span></span>
<span><span class="co">#&gt; 2        35</span></span>
<span><span class="co">#&gt; 3        74</span></span></code></pre></div>
<p>The process is then repeated for the drugissue files.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Extract data</span></span>
<span><span class="fu"><a href="../reference/cprd_extract.html">cprd_extract</a></span><span class="op">(</span><span class="va">aurum_extract</span>, </span>
<span>             filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, package <span class="op">=</span> <span class="st">"rAURUM"</span><span class="op">)</span>, </span>
<span>             filetype <span class="op">=</span> <span class="st">"drugissue"</span>, subset.patids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">6</span><span class="op">)</span>, use.set <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "nrows -1"</span></span>
<span><span class="co">#&gt; [1] "select "</span></span>
<span><span class="co">#&gt; [1] "use.set FALSE"</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_drugissue_001.txt 2024-06-12 10:57:17.631227"</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_drugissue_002.txt 2024-06-12 10:57:17.643566"</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_drugissue_003.txt 2024-06-12 10:57:17.654276"</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">### List tables</span></span>
<span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">dbListTables</span><span class="op">(</span><span class="va">aurum_extract</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "drugissue"   "observation"</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">### Query first three rows</span></span>
<span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">aurum_extract</span>, <span class="st">'SELECT * FROM drugissue'</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;   patid issueid pracid probobsid drugrecid issuedate enterdate staffid</span></span>
<span><span class="co">#&gt; 1     1      93      1        88        83    -16118     -1013      98</span></span>
<span><span class="co">#&gt; 2     1      93      1        55        59    -13322    -12900      88</span></span>
<span><span class="co">#&gt; 3     1      16      1        22        82     -8677     -3543      50</span></span>
<span><span class="co">#&gt;         prodcodeid dosageid quantity quantunitid duration estnhscost quanunitid</span></span>
<span><span class="co">#&gt; 1 3092241000033113       58       18          33       27         12          6</span></span>
<span><span class="co">#&gt; 2   92041000033111       62       93          83       59         11         25</span></span>
<span><span class="co">#&gt; 3  971241000033111       87       43          83       88         65         92</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">### Disconnect</span></span>
<span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">aurum_extract</span><span class="op">)</span></span></code></pre></div>
<p>The string to match on, function to read in the raw data, and the
name of the table in the SQLite database, can be altered using the
<code>str.match</code>, <code>extract.txt.func</code> and
<code>tablename</code> arguments respectively. Note that this function
may run for a considerable period of time when working with the entire
CPRD AURUM database, and therefore it is not recommended to run
interactively. While creation of the SQLite database may be time
consuming, subsequent queries will be far more efficient, so this is
short term pain for a long term gain.</p>
</div>
<div class="section level4">
<h4 id="add-all-relevant-files-to-sqlite-database-in-a-comptationally-efficient-manner-using-the-set-functionality-">Add all relevant files to SQLite database in a comptationally
efficient manner using the <code>set</code> functionality.<a class="anchor" aria-label="anchor" href="#add-all-relevant-files-to-sqlite-database-in-a-comptationally-efficient-manner-using-the-set-functionality-"></a>
</h4>
<p>When the number of patients in your cohort is very large (say
20,000,000, which we recently encountered), the
<code>add_to_database</code> function may perform very slowly. This is
because for each observation in the file being added to the SQLite
database, <code>add_to_database</code> checks to see whether the patid
is contained in the vector <code>subset.patids</code> (a vector of
length 20,000,000 in our case). We can utilise the structure of the CPRD
AURUM data to speed up this process. If data has the <em>set</em> naming
convention (see section 2.1), we know that we only need to search for
patids from <code>subset.patids</code>, that are in the corresponding
patient file. For example, when reading in file
<em>aurum_allpatid_set1_extract_observation_00Y.txt</em> (for any
<em>Y</em>), we only need to search whether patid is in the vector of
patids from <code>subset.patid</code>, that are also in
<em>aurum_allpatid_set1_extract_patient_001.txt</em>, which is much
smaller vector. This can reduce the time <code>add_to_database</code>
takes to run from hours to minutes. When running
<code>cprd_extract</code> on hundreds on files, this could reduce months
of computation time to days.</p>
<p>To achieve this, the <code>subset.patids</code> object should be a
data frame with two required columns. The first column should be
<code>patid</code>, the second should be <code>set</code>, reporting the
corresponding value of set which the patient belongs to. The first step
is therefore to create a patient file, which has an extra variable
<code>set</code>, the number following the text string <em>set</em> in
the patient file containing data for that patient. When reading in the
patient files to create a cohort, this can be done by specifying
<code>set = TRUE</code>. In this example, all individuals in our cohort
come from the file with string <em>set1</em>, and therefore this
variable is the same for all individuals in this cohort, however this
will not be the case in practice.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_cohort.html">extract_cohort</a></span><span class="op">(</span>filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, package <span class="op">=</span> <span class="st">"rAURUM"</span><span class="op">)</span>, patids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">6</span><span class="op">)</span><span class="op">)</span>, set <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">pat</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    4 obs. of  13 variables:</span></span>
<span><span class="co">#&gt;  $ patid         : chr  "1" "3" "4" "6"</span></span>
<span><span class="co">#&gt;  $ pracid        : int  49 98 53 54</span></span>
<span><span class="co">#&gt;  $ usualgpstaffid: chr  "6" "43" "72" "11"</span></span>
<span><span class="co">#&gt;  $ gender        : int  2 1 2 1</span></span>
<span><span class="co">#&gt;  $ yob           : int  1984 1930 1915 1914</span></span>
<span><span class="co">#&gt;  $ mob           : int  NA NA NA NA</span></span>
<span><span class="co">#&gt;  $ emis_ddate    : Date, format: "1976-11-21" "1972-06-01" ...</span></span>
<span><span class="co">#&gt;  $ regstartdate  : Date, format: "1940-07-24" "1913-07-02" ...</span></span>
<span><span class="co">#&gt;  $ patienttypeid : int  58 81 10 85</span></span>
<span><span class="co">#&gt;  $ regenddate    : Date, format: "1996-08-25" "1997-04-24" ...</span></span>
<span><span class="co">#&gt;  $ acceptable    : int  1 1 0 1</span></span>
<span><span class="co">#&gt;  $ cprd_ddate    : Date, format: "1935-03-17" "1912-04-27" ...</span></span>
<span><span class="co">#&gt;  $ set           : num  1 1 1 1</span></span></code></pre></div>
<p>The patient file read in is the same as previously, with the addition
of the <code>set</code> column. This file can be reduced to just the
<code>patid</code> and <code>set</code> columsn, and used as the input
to <code>subset.patids</code> when running the
<code>add_to_database</code> and <code>cprd_extract</code> functions.
When extracting data from observation files with <em>set1</em> in the
name, it will only search for patient id’s with <code>set == 1</code> in
the data.frame provided to <code>subset.patids</code>.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Create connection to SQLite database</span></span>
<span><span class="va">aurum_extract</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/connect_database.html">connect_database</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"temp.sqlite"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Add observation files</span></span>
<span><span class="fu"><a href="../reference/cprd_extract.html">cprd_extract</a></span><span class="op">(</span><span class="va">aurum_extract</span>, </span>
<span>             filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, package <span class="op">=</span> <span class="st">"rAURUM"</span><span class="op">)</span>, </span>
<span>             filetype <span class="op">=</span> <span class="st">"observation"</span>, nrows <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, select <span class="op">=</span> <span class="cn">NULL</span>, subset.patids <span class="op">=</span> <span class="va">pat</span>, use.set <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "nrows -1"</span></span>
<span><span class="co">#&gt; [1] "select "</span></span>
<span><span class="co">#&gt; [1] "use.set TRUE"</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_observation_001.txt 2024-06-12 10:57:17.812281"</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_observation_002.txt 2024-06-12 10:57:17.827646"</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_observation_003.txt 2024-06-12 10:57:17.838753"</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">### Add drugissue files</span></span>
<span><span class="fu"><a href="../reference/cprd_extract.html">cprd_extract</a></span><span class="op">(</span><span class="va">aurum_extract</span>, </span>
<span>             filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, package <span class="op">=</span> <span class="st">"rAURUM"</span><span class="op">)</span>, </span>
<span>             filetype <span class="op">=</span> <span class="st">"drugissue"</span>, nrows <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, select <span class="op">=</span> <span class="cn">NULL</span>, subset.patids <span class="op">=</span> <span class="va">pat</span>, use.set <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "nrows -1"</span></span>
<span><span class="co">#&gt; [1] "select "</span></span>
<span><span class="co">#&gt; [1] "use.set TRUE"</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_drugissue_001.txt 2024-06-12 10:57:17.85104"</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_drugissue_002.txt 2024-06-12 10:57:17.862983"</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_drugissue_003.txt 2024-06-12 10:57:17.876501"</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">### Query first three rows of each table</span></span>
<span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">aurum_extract</span>, <span class="st">'SELECT * FROM observation'</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;   patid consid pracid obsid obsdate enterdate staffid parentobsid</span></span>
<span><span class="co">#&gt; 1     1     33      1   100  -15931      -994      79          95</span></span>
<span><span class="co">#&gt; 2     1     66      1    46  -13782    -15232      34          17</span></span>
<span><span class="co">#&gt; 3     1     41      1    53  -20002      8845      35          79</span></span>
<span><span class="co">#&gt;           medcodeid value numunitid obstypeid numrangelow numrangehigh</span></span>
<span><span class="co">#&gt; 1   498521000006119    48        16        20          28           86</span></span>
<span><span class="co">#&gt; 2         401539014    22         1         2          27            8</span></span>
<span><span class="co">#&gt; 3 13483031000006114    17        78        13          87           41</span></span>
<span><span class="co">#&gt;   probobsid</span></span>
<span><span class="co">#&gt; 1        54</span></span>
<span><span class="co">#&gt; 2        35</span></span>
<span><span class="co">#&gt; 3        74</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">aurum_extract</span>, <span class="st">'SELECT * FROM drugissue'</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;   patid issueid pracid probobsid drugrecid issuedate enterdate staffid</span></span>
<span><span class="co">#&gt; 1     1      93      1        88        83    -16118     -1013      98</span></span>
<span><span class="co">#&gt; 2     1      93      1        55        59    -13322    -12900      88</span></span>
<span><span class="co">#&gt; 3     1      16      1        22        82     -8677     -3543      50</span></span>
<span><span class="co">#&gt;         prodcodeid dosageid quantity quantunitid duration estnhscost quanunitid</span></span>
<span><span class="co">#&gt; 1 3092241000033113       58       18          33       27         12          6</span></span>
<span><span class="co">#&gt; 2   92041000033111       62       93          83       59         11         25</span></span>
<span><span class="co">#&gt; 3  971241000033111       87       43          83       88         65         92</span></span></code></pre></div>
<p>Note that there is no difference compared to the previously extracted
SQLite databases. The computational gains from applying the subsetting
in this manner will not be realised in this example. We do not close the
connection, as we will now move onto querying the database to extract
variables for creating an analysis-ready dataset.</p>
</div>
</div>
<div class="section level3">
<h3 id="querying-the-sqlite-dataabase-to-extract-variables">Querying the SQLite dataabase to extract variables<a class="anchor" aria-label="anchor" href="#querying-the-sqlite-dataabase-to-extract-variables"></a>
</h3>
<p>Once the data has been extracted and stored in an SQLite database, it
can now be queried to create variables of interest. The normal process
for extracting variables from electronic health records is to create
codelists, a group of codes which denote the same condition. The
database would then be queried for observations with medical codes
matching those in the codelist. A <code>variable</code> would then be
defined based on this query. Whether this is a binary variable,
indicating whether an individual has any record of a given code, or the
most recent test result with the given code, or something much more
complex. In CPRD Aurum, medical diagnoses and tests are identified from
the <em>observation</em> file using <em>medcodeids</em>, and
prescription data is identified from the drugissue file using
<em>prodcodeids</em>. Creation of codelists is an important step of data
extraction, and we refer elsewhere for details on best practice for
developing codelists, and the limitations of working with codelists
<span class="citation">Gulliford et al. (2009)</span>.</p>
<div class="section level4">
<h4 id="low-level-functions">Low level functions<a class="anchor" aria-label="anchor" href="#low-level-functions"></a>
</h4>
<p>The <code>db_query</code> function will query the SQLite database for
observations where <em>medcodeid</em> is in a specified codelist. For
example, we can query the <em>observation</em> table for all codes with
<em>medcodeid</em> of 187341000000114.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db.query</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/db_query.html">db_query</a></span><span class="op">(</span>db.open <span class="op">=</span> <span class="va">aurum_extract</span>,</span>
<span>                     tab <span class="op">=</span><span class="st">"observation"</span>,</span>
<span>                     codelist.vector <span class="op">=</span> <span class="st">"187341000000114"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">db.query</span></span>
<span><span class="co">#&gt;     patid consid pracid  obsid obsdate enterdate staffid parentobsid</span></span>
<span><span class="co">#&gt;    &lt;char&gt; &lt;char&gt;  &lt;int&gt; &lt;char&gt;   &lt;num&gt;     &lt;num&gt;  &lt;char&gt;      &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:      1     42      1     81   -5373      4302      85          35</span></span>
<span><span class="co">#&gt; 2:      6     40      1     41  -14727     -6929      98          80</span></span>
<span><span class="co">#&gt;          medcodeid value numunitid obstypeid numrangelow numrangehigh probobsid</span></span>
<span><span class="co">#&gt;             &lt;char&gt; &lt;num&gt;     &lt;int&gt;     &lt;int&gt;       &lt;num&gt;        &lt;num&gt;    &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: 187341000000114    84        79        67          24           22         5</span></span>
<span><span class="co">#&gt; 2: 187341000000114    28        20         5          41           97        92</span></span></code></pre></div>
<p>The <code>combine_query_boolean</code> function will assess whether
each individual in a specified cohort has an observation in the queried
data (obtained using <code>db_query</code>) within a specified time
frame from the index date, returning a 0/1 vector. The
<code>cohort</code> must contain a variable called <code>indexdt</code>
containing the index date. This function is useful when defining
‘history of’ type variables, where we want to know if there is any
record of a given condition prior to the index date.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Add an index date to pat</span></span>
<span><span class="va">pat</span><span class="op">$</span><span class="va">indexdt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"01/01/2020"</span>, format <span class="op">=</span> <span class="st">"%d/%m/%Y"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Combine query with cohort creating a boolean variable denoting 'history of'</span></span>
<span><span class="va">combine.query.boolean</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combine_query_boolean.html">combine_query_boolean</a></span><span class="op">(</span>cohort <span class="op">=</span> <span class="va">pat</span>,</span>
<span>                                               db.query <span class="op">=</span> <span class="va">db.query</span>,</span>
<span>                                               query.type <span class="op">=</span> <span class="st">"observation"</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">combine.query.boolean</span></span>
<span><span class="co">#&gt; [1] 1 0 0 1</span></span></code></pre></div>
<p>The <code>combine_query</code> function will merge a cohort with the
queried data (obtained using <code>db_query</code>), returning a
specified number of observations (<code>numobs</code>) within a
specified time frame from the index date. This is useful when extracting
test data and requiring access to the values of the tests, or when
specifying variables that require &gt; 1 observation within a certain
time frame (i.e. two prescriptions within a month prior to index date).
For queries from the <code>observation</code> table, the query type can
be specified as <code>"med"</code> or <code>"test"</code>. Inputting
<code>query.type = "med"</code> will just return the date of the
observations and the <em>medcodeid</em>.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Combine query with cohort retaining most recent three records</span></span>
<span><span class="va">combine.query</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combine_query.html">combine_query</a></span><span class="op">(</span>cohort <span class="op">=</span> <span class="va">pat</span>,</span>
<span>                               db.query <span class="op">=</span> <span class="va">db.query</span>,</span>
<span>                               query.type <span class="op">=</span> <span class="st">"med"</span>,</span>
<span>                               numobs <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">combine.query</span></span>
<span><span class="co">#&gt;     patid       medcodeid obsdate</span></span>
<span><span class="co">#&gt;    &lt;char&gt;          &lt;char&gt;   &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      1 187341000000114   -5373</span></span>
<span><span class="co">#&gt; 2:      6 187341000000114  -14727</span></span></code></pre></div>
<p>For <code>query.type = "test"</code>, the <code>value</code> and
other relevant information will also be returned, and those with NA
values removed (although this can be altered through argument
<code>value.na.rm</code>).</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Extract a history of type variable using extract_ho</span></span>
<span><span class="va">combine.query</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combine_query.html">combine_query</a></span><span class="op">(</span>cohort <span class="op">=</span> <span class="va">pat</span>,</span>
<span>                               db.query <span class="op">=</span> <span class="va">db.query</span>,</span>
<span>                               query.type <span class="op">=</span> <span class="st">"test"</span>,</span>
<span>                               numobs <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">combine.query</span></span>
<span><span class="co">#&gt;     patid       medcodeid obsdate value numunitid numrangelow numrangehigh</span></span>
<span><span class="co">#&gt;    &lt;char&gt;          &lt;char&gt;   &lt;num&gt; &lt;num&gt;     &lt;int&gt;       &lt;num&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      1 187341000000114   -5373    84        79          24           22</span></span>
<span><span class="co">#&gt; 2:      6 187341000000114  -14727    28        20          41           97</span></span></code></pre></div>
<p>If the query was from the <code>drugissue</code> table, then
<code>query.type = "drugissue"</code> should be specified, and the date
of the observations and the <em>prodcodeid</em> will be returned. The
functions in this section do very little processing of the extracted
data, and further programming would be required around these in order to
define most variables. Some functions which do this are provided in the
next section.</p>
</div>
<div class="section level4">
<h4 id="mid-level-functions">Mid-level functions<a class="anchor" aria-label="anchor" href="#mid-level-functions"></a>
</h4>
<p>A number of functions have been written to cover the extraction of
common variable types, utilising the functions from the previous
section. The first is <code>extract_ho</code>, which defines a binary
variable whether individual has a specified code recorded prior to index
date. This can be applied to search for history of medical diagnoses or
prescriptions. The index date can be any variable in the cohort dataset,
and is specified through the <code>indexdt</code> argument.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Define codelist</span></span>
<span><span class="va">codelist</span> <span class="op">&lt;-</span> <span class="st">"187341000000114"</span></span>
<span></span>
<span><span class="co">### Add an index date to cohort</span></span>
<span><span class="va">pat</span><span class="op">$</span><span class="va">fup_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"01/01/2020"</span>, format <span class="op">=</span> <span class="st">"%d/%m/%Y"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Extract a history of type variable using extract_ho</span></span>
<span><span class="va">ho</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_ho.html">extract_ho</a></span><span class="op">(</span>cohort <span class="op">=</span> <span class="va">pat</span>, </span>
<span>                 codelist.vector <span class="op">=</span> <span class="va">codelist</span>, </span>
<span>                 indexdt <span class="op">=</span> <span class="st">"fup_start"</span>, </span>
<span>                 db.open <span class="op">=</span> <span class="va">aurum_extract</span>, </span>
<span>                 tab <span class="op">=</span> <span class="st">"observation"</span>,</span>
<span>                 return.output <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">ho</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    4 obs. of  2 variables:</span></span>
<span><span class="co">#&gt;  $ patid: chr  "1" "3" "4" "6"</span></span>
<span><span class="co">#&gt;  $ ho   : int  1 0 0 1</span></span></code></pre></div>
<p>The second is <code>extract_time_until</code>, which defines a
time-to-event/survival variable. This has two components, the time until
the first record of a specified code or censoring, and an indicator for
whether event was observed or censored. To derive a variable of this
type the cohort must also contain a time until censoring variable, which
can be specified through <code>censdt</code>.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Add an censoring date to cohort</span></span>
<span><span class="va">pat</span><span class="op">$</span><span class="va">fup_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"01/01/2024"</span>, format <span class="op">=</span> <span class="st">"%d/%m/%Y"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Extract a time until variable using extract_time_until</span></span>
<span><span class="va">time_until</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_time_until.html">extract_time_until</a></span><span class="op">(</span>cohort <span class="op">=</span> <span class="va">pat</span>, </span>
<span>                                 codelist.vector <span class="op">=</span> <span class="va">codelist</span>, </span>
<span>                                 indexdt <span class="op">=</span> <span class="st">"fup_start"</span>, </span>
<span>                                 censdt <span class="op">=</span> <span class="st">"fup_end"</span>,</span>
<span>                                 db.open <span class="op">=</span> <span class="va">aurum_extract</span>, </span>
<span>                                 tab <span class="op">=</span> <span class="st">"observation"</span>,</span>
<span>                                 return.output <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">time_until</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    4 obs. of  3 variables:</span></span>
<span><span class="co">#&gt;  $ patid        : chr  "1" "3" "4" "6"</span></span>
<span><span class="co">#&gt;  $ var_time     : num  1461 1461 1461 1461</span></span>
<span><span class="co">#&gt;  $ var_indicator: num  0 0 0 0</span></span></code></pre></div>
<p>The third is <code>extract_test</code>, which will extract the most
recent test result in a given time frame. The number of days before and
after the index date to search for results are specified through
<code>time.post</code> and <code>time.prev</code> respectively. Test
results are identified from the observation file, using code lists.
Lower and upper bounds can also be specified for the extracted data
through <code>lower.bound</code> and <code>upper.bound</code>.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Extract test data using extract_test_data</span></span>
<span><span class="va">test_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_test_data.html">extract_test_data</a></span><span class="op">(</span>cohort <span class="op">=</span> <span class="va">pat</span>, </span>
<span>                               codelist.vector <span class="op">=</span> <span class="va">codelist</span>, </span>
<span>                               indexdt <span class="op">=</span> <span class="st">"fup_start"</span>, </span>
<span>                               db.open <span class="op">=</span> <span class="va">aurum_extract</span>,</span>
<span>                               time.post <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                               time.prev <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>                               return.output <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">test_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    4 obs. of  2 variables:</span></span>
<span><span class="co">#&gt;  $ patid: chr  "1" "3" "4" "6"</span></span>
<span><span class="co">#&gt;  $ value: num  84 NA NA 28</span></span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">### Disconnect</span></span>
<span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">aurum_extract</span><span class="op">)</span></span></code></pre></div>
<p>Once all the variables of interest have been extracted, they can be
merged into an analysis-ready dataset.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Recursive merge</span></span>
<span><span class="va">analysis.ready.pat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">df1</span>, <span class="va">df2</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">df1</span>, <span class="va">df2</span>, by <span class="op">=</span> <span class="st">"patid"</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">pat</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"patid"</span>, <span class="st">"gender"</span>, <span class="st">"yob"</span><span class="op">)</span><span class="op">]</span>, <span class="va">ho</span>, <span class="va">time_until</span>, <span class="va">test_data</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">analysis.ready.pat</span></span>
<span><span class="co">#&gt;   patid gender  yob ho var_time var_indicator value</span></span>
<span><span class="co">#&gt; 1     1      2 1984  1     1461             0    84</span></span>
<span><span class="co">#&gt; 2     3      1 1930  0     1461             0    NA</span></span>
<span><span class="co">#&gt; 3     4      2 1915  0     1461             0    NA</span></span>
<span><span class="co">#&gt; 4     6      1 1914  1     1461             0    28</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="high-level-functions">High level functions<a class="anchor" aria-label="anchor" href="#high-level-functions"></a>
</h4>
<p>There are also a number of higher level functions that can be used to
extract specific variables:</p>
<ul>
<li>
<code>extract_bmi</code>: Derives BMI scores. Requires specification
of codelist for BMI, height, and weight separately.</li>
<li>
<code>extract_cholhdl_ratio</code>: Derives total
cholesterol/high-density lipoprotein ratio. Requires specification of
separate codelists for total cholesterol/high-density lipoprotein ratio,
total cholesterol, and high-density lipoproteins separately.</li>
<li>
<code>extract_diabetes</code>: Derives a categorical variable for
history of type 1 diabetes, history of type 2 diabetes or no history of
diabetes. Requires specification of separate codelists for type 1 and
type 2 diabetes.</li>
<li>
<code>extract_smoking</code>: Derives a categorical variable for
smoking status. Requires specification of seperate codelists for
non-smoker, ex-smoker, light smoker, moderate smoker and heavy smoker.
If the most recent smoking status is non-smoker, but there are
historical codes which indicate smoking, then individual will be
classified as an ex-smoker.</li>
<li>
<code>extract_test_data_var</code>: Derives standard deviation of
test data values recorded over a specified time period.</li>
</ul>
</div>
<div class="section level4">
<h4 id="saving-extracted-variables-directly-to-the-hard-disk-and-utilising-raurums-suggested-directory-system">Saving extracted variables directly to the hard disk, and utilising
rAURUMs suggested directory system<a class="anchor" aria-label="anchor" href="#saving-extracted-variables-directly-to-the-hard-disk-and-utilising-raurums-suggested-directory-system"></a>
</h4>
<p>So far all extracted variables have been read into the R workspace by
specifying <code>return.output = TRUE</code>. When working with large
cohorts it may be preferable to save the output directly onto the hard
disk, by specifying <code>out.save.disk = TRUE</code>. The file path to
save the output can be specified manually through the
<code>out.filepath</code> argument. However, is this argument is left as
<code>NULL</code>, <strong>rAURUM</strong> will try to save the
extracted variable into a directory “data/extraction/”. The name of the
file itself will be dependent on the variable name specified through
argument <code>varname</code>. This can be a very convenient way to save
the output directly to disk without having to repeatedly specify file
paths and file names.</p>
<p>There is similar functionality when specifying the codelists.
Codelists can be specified in two ways. The first is to read the
codelist into R as a character vector and then specify through the
argument <code>codelist.vector</code>, which has been done in all the
previous examples. Alternatively, codelists stored on the hard disk can
be referred to from the <code>codelist</code> argument in many
<strong>rAURUM</strong> functions, but requires a specific underlying
directory structure. The codelist on the hard disk must be stored in a
directory called “codelists/analysis/” relative to the working
directory. The codelist must be a .csv file, and contain a column
<em>medcodeid</em>, <em>prodcodeid</em> or <em>ICD10</em> depending on
the table being queried. The input to argument <code>codelist</code>
should just be a character string of the name of the files (excluding
the suffix ‘.csv’). The <code>codelist.vector</code> option will take
precedence over the <code>codelist</code> argument if both are
specified.</p>
<p>Finally, there is similar functionality for accessing the SQLite
database internally, rather than having to open a connection, use this
as an input in the functions, and then remember to close the connection.
Instead, if the SQLite database is stored in a directory “data/sql/”
relative to the working directory, the SQLite database can be referred
to by name (a character string) in the argument <code>db</code>.
Alternatively, a SQLite database stored anywhere on the hard disk can be
accessed by specifying the full filepath (character string) in the
argument <code>db.filepath</code>. A connection to the SQLite datbase
will be opened, the SQLite database will be queried, and then the
connection closed.</p>
<p>This workflow is advantageous as it avoids hard file paths,
beneficial if wanting to move your code onto another computer system.
Furthermore, once codelists and SQLite database have been created and
stored in the appropriate folder, they can simply be referred to by
name, resulting in an easier workflow. The function
<code><a href="../reference/create_directory_system.html">create_directory_system()</a></code> will create the directory system
required to use <strong>rAURUM</strong> in this way. To avoid repetition
of the previous section, this is showcased just once using the
<code>extract_ho</code> function. We start by creating a temporary
directory and setting this to be the working directory. Note to maintain
the new working directory across multiple code chunks, we use
<code>knitr::opts_knit$set</code>, however the user can implement this
step as usual using <code><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd()</a></code>:</p>
<p>Next, the <code><a href="../reference/create_directory_system.html">create_directory_system()</a></code> function can be used
to generate the required directory structure:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/create_directory_system.html">create_directory_system</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "The working directory is /home/runner/work/_temp/Library/rAURUM/example"</span></span></code></pre></div>
<p>An SQLite database called “mydb.sqlite” is then created in the
“data/sql” directory, using the same data from the previous
examples:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Open connection</span></span>
<span><span class="va">aurum_extract</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/connect_database.html">connect_database</a></span><span class="op">(</span><span class="st">"data/sql/mydb.sqlite"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Add data to SQLite database using cprd_extract</span></span>
<span><span class="fu"><a href="../reference/cprd_extract.html">cprd_extract</a></span><span class="op">(</span><span class="va">aurum_extract</span>,</span>
<span>filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, package <span class="op">=</span> <span class="st">"rAURUM"</span><span class="op">)</span>,</span>
<span>filetype <span class="op">=</span> <span class="st">"observation"</span>, use.set <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "nrows -1"</span></span>
<span><span class="co">#&gt; [1] "select "</span></span>
<span><span class="co">#&gt; [1] "use.set FALSE"</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_observation_001.txt 2024-06-12 10:57:18.917821"</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_observation_002.txt 2024-06-12 10:57:18.93015"</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_observation_003.txt 2024-06-12 10:57:18.940758"</span></span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">## Disconnect</span></span>
<span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">aurum_extract</span><span class="op">)</span></span></code></pre></div>
<p>Finally, a code list called <em>mylist.csv</em> is created and saved
into the <em>codelists/analysis/</em> directory.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Define codelist</span></span>
<span><span class="va">codelist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>medcodeid <span class="op">=</span> <span class="st">"187341000000114"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Save codelist</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">codelist</span>, <span class="st">"codelists/analysis/mylist.csv"</span><span class="op">)</span></span></code></pre></div>
<p>The <em>mydb.sqlite</em> database can now be queried to create a
‘history of’ type variable using the codelist <em>mylist.csv</em>, with
the output saved directly onto the hard disk.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/extract_ho.html">extract_ho</a></span><span class="op">(</span>cohort <span class="op">=</span> <span class="va">pat</span>,</span>
<span>           codelist <span class="op">=</span> <span class="st">"mylist"</span>,</span>
<span>           indexdt <span class="op">=</span> <span class="st">"fup_start"</span>,</span>
<span>           db <span class="op">=</span> <span class="st">"mydb"</span>,</span>
<span>           tab <span class="op">=</span> <span class="st">"observation"</span>,</span>
<span>           out.save.disk <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;   patid ho</span></span>
<span><span class="co">#&gt; 1     1  1</span></span>
<span><span class="co">#&gt; 3     3  0</span></span>
<span><span class="co">#&gt; 4     4  0</span></span>
<span><span class="co">#&gt; 6     6  1</span></span></code></pre></div>
<p>Note there is no output from this function. Instead the extracted
variable has been saved onto the hard disk in an .rds file, and can be
read in using:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data/extraction/var_ho.rds"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   patid ho</span></span>
<span><span class="co">#&gt; 1     1  1</span></span>
<span><span class="co">#&gt; 3     3  0</span></span>
<span><span class="co">#&gt; 4     4  0</span></span>
<span><span class="co">#&gt; 6     6  1</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="extracting-longitudinal-datatime-varying-covariates">Extracting longitudinal data/time varying covariates<a class="anchor" aria-label="anchor" href="#extracting-longitudinal-datatime-varying-covariates"></a>
</h4>
<p>All of the mid and high level functions have the option to extract
data at a given time point post index date (specified through the
<code>t</code> argument). This allows uesrs to extract data at fixed
intervals, which can be utilised for longitudinal analyses where
time-varying covariates are required. If saving the extracted variables
directly to the hard disk (<code>out.save.disk = TRUE</code>), the time
at which data was extracted from, <code>t</code>, will be added to the
file name by default.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="discussion">Discussion<a class="anchor" aria-label="anchor" href="#discussion"></a>
</h2>
<p><strong>rAURUM</strong> is an R package which allows users to process
CPRD Aurum data in a consistent and computationally efficiency manner.
It avoids messy for loops, reducing the chance of coding errors, and
enables querying of large databases that could not be handled in the R
workspace. Functions are also provided to extract common variable types
(history of a specified condition, time until event occurs, or most
recent test result), and some common variables which require extract
processing (body mass index, cholesterol-high density lipoprotein ratio,
smoking status, diabetes category). The component
<strong>rAURUM</strong> which extracts the raw eletronic health record
and stores in an SQLite database has been written with flexibility in
mind. The user can define their own functions for reading in the raw
data, allowing these functions to be applied to other electronic health
records, or future versions of CPRD Aurum which have different data
structures. The main goal of this package is to reduce the duplication
of efforts among those using CPRD data for their research, allowing more
time to be focused on other aspects of research projects.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-ClinicalPracticeResearchDatalink2022" class="csl-entry">
CPRD. 2022. <span>“<span>CPRD Aurum Data Specification. Version
2.7</span>.”</span> <a href="https://www.cprd.com/sites/default/files/2022-02/CPRD%20Aurum%20Data%20Specification%20v2.7%20%28002%29.pdf" class="external-link">https://www.cprd.com/sites/default/files/2022-02/CPRD
Aurum Data Specification v2.7 %28002%29.pdf</a>.
</div>
<div id="ref-CPRD2024" class="csl-entry">
———. 2024a. <span>“<span>CPRD Aurum March 2024 Dataset</span>.”</span>
<a href="https://www.cprd.com/doi/cprd-aurum-march-2024-dataset" class="external-link">https://www.cprd.com/doi/cprd-aurum-march-2024-dataset</a>.
</div>
<div id="ref-ClinicalPracticeResearchDatalink" class="csl-entry">
———. 2024b. <span>“<span>CPRD GOLD June 2024 Dataset</span>.”</span> <a href="https://www.cprd.com/doi/cprd-gold-june-2024-dataset" class="external-link">https://www.cprd.com/doi/cprd-gold-june-2024-dataset</a>.
</div>
<div id="ref-Gulliford2009" class="csl-entry">
Gulliford, Martin C., Judith Charlton, Mark Ashworth, Anthony G. Rudd,
Andre Michael Toschke, Brendan Delaney, Andy Grieve, et al. 2009.
<span>“<span class="nocase">Selection of medical diagnostic codes for
analysis of electronic patient records. Application to stroke in a
primary care database</span>.”</span> <em>PLoS ONE</em> 4 (9). <a href="https://doi.org/10.1371/journal.pone.0007168" class="external-link">https://doi.org/10.1371/journal.pone.0007168</a>.
</div>
<div id="ref-Muller2024" class="csl-entry">
Müller, Kirill, Hadley Wickham, David A. James, and Seth Falcon. 2024.
<span>“<span class="nocase">RSQLite: SQLite Interface for
R</span>.”</span> <a href="https://rsqlite.r-dbi.org" class="external-link">https://rsqlite.r-dbi.org</a>.
</div>
<div id="ref-Pye2018" class="csl-entry">
Pye, Stephen R., Thérèse Sheppard, Rebecca M. Joseph, Mark Lunt, Nadyne
Girard, Jennifer S. Haas, David W. Bates, et al. 2018. <span>“<span class="nocase">Assumptions made when preparing drug exposure data for
analysis have an impact on results: An unreported step in
pharmacoepidemiology studies</span>.”</span> <em>Pharmacoepidemiology
and Drug Safety</em> 27 (7): 781–88. <a href="https://doi.org/10.1002/pds.4440" class="external-link">https://doi.org/10.1002/pds.4440</a>.
</div>
<div id="ref-Springate2017" class="csl-entry">
Springate, David A., Rosa Parisi, Ivan Olier, David Reeves, and
Evangelos Kontopantelis. 2017. <span>“<span class="nocase">rEHR: An R
package for manipulating and analysing electronic health record
data</span>.”</span> <em>PLoS ONE</em> 12 (2): 1–25. <a href="https://doi.org/10.1371/journal.pone.0171784" class="external-link">https://doi.org/10.1371/journal.pone.0171784</a>.
</div>
<div id="ref-TheHealthFoundationAnalyticsLab2021" class="csl-entry">
The Health Foundation Analytics Lab. 2021. <span>“Aurumpipeline.”</span>
<a href="https://github.com/HFAnalyticsLab/aurumpipeline" class="external-link">https://github.com/HFAnalyticsLab/aurumpipeline</a>.
</div>
<div id="ref-Watson2017" class="csl-entry">
Watson, Jessica, Brian D. Nicholson, Willie Hamilton, and Sarah Price.
2017. <span>“<span class="nocase">Identifying clinical features in
primary care electronic health record studies: Methods for codelist
development</span>.”</span> <em>BMJ Open</em> 7 (11): 1–9. <a href="https://doi.org/10.1136/bmjopen-2017-019637" class="external-link">https://doi.org/10.1136/bmjopen-2017-019637</a>.
</div>
<div id="ref-Williams2019" class="csl-entry">
Williams, Richard, Benjamin Brown, Evan Kontopantelis, Tjeerd van Staa,
and Niels Peek. 2019. <span>“<span class="nocase">Term sets: A
transparent and reproducible representation of clinical code
sets</span>.”</span> <em>PLoS ONE</em> 14 (2): 1–15. <a href="https://doi.org/10.1371/journal.pone.0212291" class="external-link">https://doi.org/10.1371/journal.pone.0212291</a>.
</div>
<div id="ref-Williams2017" class="csl-entry">
Williams, Richard, Evangelos Kontopantelis, Iain Buchan, and Niels Peek.
2017. <span>“<span class="nocase">Clinical code set engineering for
reusing EHR data for research: A review</span>.”</span> <em>Journal of
Biomedical Informatics</em> 70: 1–13. <a href="https://doi.org/10.1016/j.jbi.2017.04.010" class="external-link">https://doi.org/10.1016/j.jbi.2017.04.010</a>.
</div>
<div id="ref-Yimer2021" class="csl-entry">
Yimer, Belay Birlie, David Selby, Meghna Jani, Goran Nenadic, Mark Lunt,
and William G. Dixon. 2021. <span>“<span class="nocase">drugprepr:
Prepare Electronic Prescription Record Data to Estimate Drug
Exposure</span>.”</span> <a href="https://cran.r-project.org/package=drugprepr" class="external-link">https://cran.r-project.org/package=drugprepr</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Alexander Pate.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
