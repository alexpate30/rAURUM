---
title: "extracting-and-saving-data-without-hard-filepaths"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{extracting-and-saving-data-without-hard-filepaths}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

This vignette will illustrate how to set up a directory structure, so that the variable extraction functions can be run without having to manually open a connection to the SQLite database, without having the manually read in code lists, and without having to manually save extracted variables onto the hard disk. Instead this will all be done automatically under the bonnet. 

Start by loading rAURUM.

```{r setup}
library(rAURUM)
```

Next, we create a temporary directory and make this the working directory.

```{r}
tempdir <- tempdir()
setwd(tempdir)
```

Next, we run the function 

  ### Create directory system
  create_directory_system()

  ### Create Aurum database in data/sql

  ### Connect
  aurum_extract <- connect_database("data/sql/temp.sqlite")

  ### Extract data using cprd_extract
  cprd_extract(aurum_extract,
               filepath = system.file("aurum_data", package = "rAURUM"),
               filetype = "observation", use.set = FALSE)

  cprd_extract(aurum_extract,
               filepath = system.file("aurum_data", package = "rAURUM"),
               filetype = "drugissue", use.set = FALSE)


  ### Extract a history of type variable and save to disc automatically, by just specifying name of database
  extract_ho(pat,
             codelist.vector = codelist,
             indexdt = "fup_start",
             db = "temp",
             tab = "observation",
             out.save.disk = TRUE)

  ### Read from disk
  ho.disk <- readRDS("data/extraction/var_ho.rds")
  testthat::expect_equal(ho, ho.disk)

  ### Extract a history of type variable and save to disk using out.subdir
  extract_ho(pat,
             codelist.vector = codelist,
             indexdt = "fup_start",
             db = "temp",
             tab = "observation",
             out.subdir = "cohort",
             out.save.disk = TRUE)

  ### Read from disk
  ho.disk <- readRDS("data/extraction/cohort/var_ho.rds")
  testthat::expect_equal(ho, ho.disk)

  ### Extract a history of type variable and save to disk manually specifying filepath for output and db
  extract_ho(pat,
             codelist.vector = codelist,
             indexdt = "fup_start",
             db.filepath = "data/sql/temp.sqlite",
             tab = "observation",
             out.filepath = "data/extraction/eggs.rds",
             out.save.disk = TRUE)

  ### Read from disk
  ho.disk <- readRDS("data/extraction/eggs.rds")
  testthat::expect_equal(ho, ho.disk)

  ### Disconnect
  RSQLite::dbDisconnect(aurum_extract)

