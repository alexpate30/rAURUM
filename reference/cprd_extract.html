<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Add the raw data from more than one of the CPRD flatfiles to an SQLite database."><title>Adds all the .txt files in a directory, with certain file names, to an SQLite database on the hard disk. — cprd_extract • rAURUM</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Adds all the .txt files in a directory, with certain file names, to an SQLite database on the hard disk. — cprd_extract"><meta property="og:description" content="Add the raw data from more than one of the CPRD flatfiles to an SQLite database."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rAURUM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item">
  <a class="nav-link" href="../articles/rAURUM.html">Get started</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"></ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Adds all the .txt files in a directory, with certain file names, to an SQLite database on the hard disk.</h1>
      
      <div class="d-none name"><code>cprd_extract.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Add the raw data from more than one of the CPRD flatfiles to an SQLite database.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">cprd_extract</span><span class="op">(</span></span>
<span>  <span class="va">db</span>,</span>
<span>  <span class="va">filepath</span>,</span>
<span>  filetype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"observation"</span>, <span class="st">"drugissue"</span>, <span class="st">"referral"</span>, <span class="st">"problem"</span>, <span class="st">"consultation"</span>,</span>
<span>    <span class="st">"hes_primary"</span>, <span class="st">"death"</span><span class="op">)</span>,</span>
<span>  nrows <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>  select <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  subset.patids <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  use.set <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  extract.txt.func <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  str.match <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  tablename <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>db</dt>
<dd><p>An open SQLite database connection created using RSQLite::dbConnect.</p></dd>


<dt>filepath</dt>
<dd><p>Path to directory containing .txt files.</p></dd>


<dt>filetype</dt>
<dd><p>Type of CPRD Aurum file (observation, drugissue, referral, problem, consultation, hes_primary, death)</p></dd>


<dt>nrows</dt>
<dd><p>Number of rows to read in from .txt file.</p></dd>


<dt>select</dt>
<dd><p>Vector of column names to select before adding to the SQLite database.</p></dd>


<dt>subset.patids</dt>
<dd><p>Patient id's to subset the .txt file on before adding to the SQLite database.</p></dd>


<dt>use.set</dt>
<dd><p>Reduce subset.patids to just those with a corresponding set value to the .txt file being read in. Can greatly improve computational efficiency when subset.patids is large. See vignette XXXX for more details.</p></dd>


<dt>extract.txt.func</dt>
<dd><p>User-defined function to read the .txt file into R.</p></dd>


<dt>str.match</dt>
<dd><p>Character vector to match on when searching for file names to add to the database.</p></dd>


<dt>tablename</dt>
<dd><p>Name of table in SQLite database that the data will be added to.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>Adds .txt file to SQLite database on hard disk.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>By default, will add files that contain <code>filetype</code> in the file name to a table named <code>filetype</code> in the SQLite database.
If <code>str.match</code> is specified, will add files that contain <code>str.match</code> in the file name to a table named <code>str.match</code> in the SQLite database.
In this case, <code>filetype</code> will still be used to choose which function reads in and formats the raw data, although this can be overwritten with
<code>extract.txt.func</code>. If argument <code>tablename</code> is specified, data will be added to a table called <code>tablename</code> in the SQLite database.</p>
<p>Currently, rAURUM only deals with <code>filetype = c("observation", "drugissue", "referral", "problem", "consultation", "hes_primary", "death")</code> by default.
However, by using <code>str.match</code> and <code>extract.txt.func</code>, the user can manually search for files with any string in the file name, and read them in
and format using a user-defined function. This means the user is not restricted to only adding the pre-defined file types to the SQLite database.</p>
<p>If <code>use.set = FALSE</code>, then <code>subset.patids</code> should be a vector of patid's that the .txt files will be subsetted on before adding to the SQLite database.
If <code>use.set = TRUE</code>, then <code>subset.patids</code> should be a dataframe with two columns, <code>patid</code> and <code>set</code>, where <code>set</code> corresponds to the number in the file name
following the word 'set'. This functionality is provided to increase computational efficiency when subsetting to a cohort of patients which is very large (millions).
This can be a computationally expensive process as each flatfile being read in, must be cross matched with a large vector .
The CPRD flatfiles are split up into groups which can be identified from their naming convention. Patients from set 1, will have their data
in DrugIssue, Observation, etc, all with the same "set" suffix in the flatfile name. We can utilise this to speed up the process of subsetting
the data from the flatfiles to only those with patids in subset.patid. Instead we subset to those with patids in subset.patids, and with the
corresponding value of "set", which matches the suffix "set" in the CPRD flatfile file name. For example, patients in the Patient file which had
suffix "set1", will have their medical data in the Observation file with suffix "set1". When subsetting the Observation file to those in
subset.patids (our cohort), we only need to do so for patients who were also in the patient file with suffix "set1".
If the cohort of patients for which you want to subset the data to is very small, the computational gains from this argument are minor and it
can be ignored.</p>
<p>The function for reading in the .txt file will be chosen from a set of functions provided with rAURUM, based on  the filetype (<code>filetype</code>).
<code>extract.txt.func</code> does not need to be specified unless wanting to manually define the function for doing this. This may be beneficial if wanting to
change variable formats, or if the variables in the .txt files change in future releases of CPRD AURUM and rAURUM has not been updated.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">## Create connection to a temporary database</span></span></span>
<span class="r-in"><span><span class="va">aurum_extract</span> <span class="op">&lt;-</span> <span class="fu"><a href="connect_database.html">connect_database</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"temp.sqlite"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Add observation data from all observation files in specified directory</span></span></span>
<span class="r-in"><span><span class="fu">cprd_extract</span><span class="op">(</span>db <span class="op">=</span> <span class="va">aurum_extract</span>,</span></span>
<span class="r-in"><span>filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, package <span class="op">=</span> <span class="st">"rAURUM"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>filetype <span class="op">=</span> <span class="st">"observation"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "Adding /home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_observation_001.txt 2024-06-17 09:47:39.40778"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "Adding /home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_observation_002.txt 2024-06-17 09:47:39.420433"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "Adding /home/runner/work/_temp/Library/rAURUM/aurum_data/aurum_allpatid_set1_extract_observation_003.txt 2024-06-17 09:47:39.431583"</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Query database</span></span></span>
<span class="r-in"><span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">aurum_extract</span>, <span class="st">'SELECT * FROM observation'</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   patid consid pracid obsid obsdate enterdate staffid parentobsid</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1     1     33      1   100  -15931      -994      79          95</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2     1     66      1    46  -13782    -15232      34          17</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3     1     41      1    53  -20002      8845      35          79</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           medcodeid value numunitid obstypeid numrangelow numrangehigh</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1   498521000006119    48        16        20          28           86</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2         401539014    22         1         2          27            8</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 13483031000006114    17        78        13          87           41</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   probobsid</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1        54</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2        35</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3        74</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Alexander Pate.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer></div>

  

  

  </body></html>

